import { useState, useEffect } from 'react'
import { useNavigate } from 'react-router-dom'
import {
  Box, Container, Typography, Card, CardContent, Button, Grid, AppBar, Toolbar, IconButton, Avatar,
  Dialog, DialogTitle, DialogContent, DialogActions, TextField, MenuItem, Table, TableBody, TableCell,
  TableContainer, TableHead, TableRow, Paper, Chip, Tabs, Tab, Menu, Alert
} from '@mui/material'
import { Logout, Visibility, School, Assessment, People, TrendingUp, Brightness4, Brightness7, Settings, Lock } from '@mui/icons-material'
import { BarChart, Bar, PieChart, Pie, Cell, ComposedChart, Area, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } from 'recharts'
import api from '../api/axios'
import { useAuthStore } from '../store/authStore'
import '../styles/TeacherDashboard.css'

const TeacherDashboard = () => {
  const { user, logout } = useAuthStore()
  const navigate = useNavigate()
  const [activeTab, setActiveTab] = useState(0)
  const [darkMode, setDarkMode] = useState(() => {
    const saved = localStorage.getItem('darkMode')
    return saved === 'true'
  })
  const [exams, setExams] = useState<any[]>([])
  const [subjects, setSubjects] = useState<any[]>([])
  const [departments, setDepartments] = useState<any[]>([])
  const [courses, setCourses] = useState<any[]>([])
  const [openQuestionDialog, setOpenQuestionDialog] = useState(false)
  const [selectedExam, setSelectedExam] = useState<any>(null)
  const [studentsStatus, setStudentsStatus] = useState<any[]>([])
  const [allExamsStatus, setAllExamsStatus] = useState<any[]>([])
  const [announcements, setAnnouncements] = useState<any[]>([])
  const [unreadCount, setUnreadCount] = useState(0)
  const [feedbacks, setFeedbacks] = useState<any[]>([])
  const [selectedFeedback, setSelectedFeedback] = useState<any>(null)
  const [teacherResponse, setTeacherResponse] = useState('')
  const [openResponseDialog, setOpenResponseDialog] = useState(false)
  const [openPasswordDialog, setOpenPasswordDialog] = useState(false)
  const [passwordForm, setPasswordForm] = useState({
    old_password: '',
    new_password: '',
    confirm_password: ''
  })
  const [anchorEl, setAnchorEl] = useState<null | HTMLElement>(null)
  const [examForm, setExamForm] = useState({
    title: '', 
    description: '', 
    subject: '', 
    department: '',
    course: '',
    custom_department: '',
    custom_course: '',
    additional_info: '',
    duration_minutes: 60, 
    total_marks: 100,
    passing_marks: 40, 
    negative_marking: false, 
    negative_marks_per_question: 0,
    shuffle_questions: true, 
    start_time: '', 
    end_time: ''
  })
  const [questions, setQuestions] = useState<any[]>([])
  const [parsedQuestions, setParsedQuestions] = useState<any[]>([])
  const [uploadingPdf, setUploadingPdf] = useState(false)
  const [questionForm, setQuestionForm] = useState({
    question_text: '', question_type: 'mcq', marks: 1, option_a: '', option_b: '',
    option_c: '', option_d: '', correct_answer: '', explanation: ''
  })
  const [stats, setStats] = useState({
    totalExams: 0,
    totalStudents: 0,
    averageScore: 0,
    pendingGrading: 0
  })
  const [chartData, setChartData] = useState<any>({
    examPerformance: [],
    studentProgress: [],
    examStatusDistribution: [],
    subjectWisePerformance: []
  })

  const toggleDarkMode = () => {
    const newMode = !darkMode
    setDarkMode(newMode)
    localStorage.setItem('darkMode', String(newMode))
  }

  const COLORS = ['#0088FE', '#00C49F', '#FFBB28', '#FF8042', '#8884d8']

  useEffect(() => {
    fetchData()
    fetchAnnouncements()
    fetchUnreadCount()
    fetchFeedbacks()
  }, [])

  useEffect(() => {
    if (activeTab === 3 && !selectedExam && exams.length > 0) {
      fetchAllExamsStatus()
    }
  }, [activeTab, selectedExam, exams])

  const fetchData = async () => {
    try {
      const [examsRes, subjectsRes, attemptsRes, deptsRes, coursesRes] = await Promise.all([
        api.get('/exams/'),
        api.get('/subjects/'),
        api.get('/attempts/'),
        api.get('/departments/'),
        api.get('/courses/')
      ])
      setExams(examsRes.data)
      setSubjects(subjectsRes.data)
      setDepartments(deptsRes.data)
      setCourses(coursesRes.data)

      const totalExams = examsRes.data.length
      const evaluatedAttempts = attemptsRes.data.filter((a: any) => a.status === 'evaluated')
      const totalStudents = new Set(attemptsRes.data.map((a: any) => a.student)).size
      const averageScore = evaluatedAttempts.length > 0
        ? evaluatedAttempts.reduce((sum: number, a: any) => sum + a.percentage, 0) / evaluatedAttempts.length
        : 0
      const pendingGrading = attemptsRes.data.filter((a: any) => a.status === 'submitted').length

      setStats({ totalExams, totalStudents, averageScore, pendingGrading })

      const examPerformance = examsRes.data.slice(0, 5).map((exam: any) => {
        const examAttempts = attemptsRes.data.filter((a: any) => a.exam === exam.id && a.status === 'evaluated')
        const avgScore = examAttempts.length > 0
          ? examAttempts.reduce((sum: number, a: any) => sum + a.percentage, 0) / examAttempts.length
          : 0
        return {
          name: exam.title.substring(0, 15) + '...',
          average: avgScore.toFixed(1),
          students: examAttempts.length
        }
      })

      const statusCount = examsRes.data.reduce((acc: any, exam: any) => {
        acc[exam.status] = (acc[exam.status] || 0) + 1
        return acc
      }, {})

      const examStatusDistribution = Object.keys(statusCount).map(status => ({
        name: status.charAt(0).toUpperCase() + status.slice(1),
        value: statusCount[status]
      }))

      const studentProgress = [
        { week: 'Week 1', completed: 12, pending: 8, average: 75 },
        { week: 'Week 2', completed: 15, pending: 5, average: 78 },
        { week: 'Week 3', completed: 18, pending: 2, average: 82 },
        { week: 'Week 4', completed: 20, pending: 0, average: 85 }
      ]

      const subjectWisePerformance = subjectsRes.data.slice(0, 5).map((subject: any) => ({
        subject: subject.name,
        students: Math.floor(Math.random() * 50) + 20,
        avgScore: Math.floor(Math.random() * 30) + 70
      }))

      setChartData({
        examPerformance,
        studentProgress,
        examStatusDistribution,
        subjectWisePerformance
      })
    } catch (error) {
      console.error('Error fetching data:', error)
    }
  }

  const handlePdfUpload = async (file: File) => {
    setUploadingPdf(true)
    const formData = new FormData()
    formData.append('pdf_file', file)

    try {
      const response = await api.post('/questions/parse_pdf/', formData, {
        headers: { 'Content-Type': 'multipart/form-data' }
      })
      
      setParsedQuestions(response.data.questions)
      alert(`‚úÖ Successfully extracted ${response.data.count} questions from PDF!\nReview and edit them below, then click "Create Exam with Questions"`)
    } catch (error: any) {
      console.error('Error parsing PDF:', error)
      const errorMsg = error.response?.data?.error || error.response?.data?.message || 'Failed to parse PDF'
      alert(`‚ùå ${errorMsg}`)
    } finally {
      setUploadingPdf(false)
    }
  }

  const handleCreateExamWithQuestions = async () => {
    if (!examForm.title || !examForm.subject) {
      alert('‚ùå Please fill in exam title and subject')
      return
    }

    if (parsedQuestions.length === 0) {
      alert('‚ùå Please upload a PDF or add questions manually')
      return
    }

    let examData = { ...examForm }
    
    if (!examData.start_time) {
      const now = new Date()
      examData.start_time = now.toISOString().slice(0, 16)
      console.log('Setting default start_time:', examData.start_time)
    }
    
    if (!examData.end_time) {
      const twoHoursLater = new Date(Date.now() + 2 * 60 * 60 * 1000)
      examData.end_time = twoHoursLater.toISOString().slice(0, 16)
      console.log('Setting default end_time:', examData.end_time)
    }

    try {
      console.log('Creating exam with data:', examData)
      
      const examResponse = await api.post('/exams/', examData)
      console.log('Exam created:', examResponse.data)
      const examId = examResponse.data.id

      console.log('Adding questions:', parsedQuestions)
      
      await api.post('/questions/bulk_create/', {
        exam_id: examId,
        questions: parsedQuestions
      })

      console.log('Questions added successfully')

      alert(`‚úÖ Exam created successfully with ${parsedQuestions.length} questions!\nStatus: Pending (awaiting admin approval)`)
      
      setExamForm({
        title: '', description: '', subject: '', department: '', course: '',
        custom_department: '', custom_course: '', additional_info: '',
        duration_minutes: 60, total_marks: 100,
        passing_marks: 40, negative_marking: false, negative_marks_per_question: 0,
        shuffle_questions: true, start_time: '', end_time: ''
      })
      setParsedQuestions([])
      fetchData()
    } catch (error: any) {
      console.error('Full error object:', error)
      console.error('Error response:', error.response)
      console.error('Error response data:', error.response?.data)
      
      let errorMessage = 'Unknown error'
      
      if (error.response?.data) {
        const data = error.response.data
        if (typeof data === 'string') {
          errorMessage = data
        } else if (data.detail) {
          errorMessage = data.detail
        } else if (data.error) {
          errorMessage = data.error
        } else if (data.message) {
          errorMessage = data.message
        } else {
          const firstKey = Object.keys(data)[0]
          if (firstKey && Array.isArray(data[firstKey])) {
            errorMessage = `${firstKey}: ${data[firstKey][0]}`
          } else if (firstKey) {
            errorMessage = `${firstKey}: ${data[firstKey]}`
          } else {
            errorMessage = JSON.stringify(data)
          }
        }
      } else if (error.message) {
        errorMessage = error.message
      }
      
      alert(`‚ùå Error creating exam:\n${errorMessage}\n\nCheck browser console for details.`)
    }
  }

  const handleAddQuestion = () => {
    setQuestions([...questions, { ...questionForm, order: questions.length + 1 }])
    setQuestionForm({
      question_text: '', question_type: 'mcq', marks: 1, option_a: '', option_b: '',
      option_c: '', option_d: '', correct_answer: '', explanation: ''
    })
  }

  const handleSaveQuestions = async () => {
    try {
      await api.post('/questions/bulk_create/', {
        exam_id: selectedExam.id,
        questions: questions
      })
      setOpenQuestionDialog(false)
      setQuestions([])
      alert('Questions added successfully')
    } catch (error) {
      console.error('Error saving questions:', error)
    }
  }

  const fetchStudentsStatus = async (examId: number) => {
    try {
      const response = await api.get(`/exams/${examId}/students_status/`)
      setStudentsStatus(response.data)
    } catch (error) {
      console.error('Error fetching students status:', error)
    }
  }

  const fetchAllExamsStatus = async () => {
    try {
      const statusPromises = exams.map(exam => 
        api.get(`/exams/${exam.id}/students_status/`)
          .then(res => ({
            exam: exam,
            students: res.data
          }))
          .catch(err => {
            console.error(`Error fetching status for exam ${exam.id}:`, err)
            return { exam: exam, students: [] }
          })
      )
      const results = await Promise.all(statusPromises)
      setAllExamsStatus(results)
    } catch (error) {
      console.error('Error fetching all exams status:', error)
    }
  }

  const handleMonitorExam = (exam: any) => {
    setSelectedExam(exam)
    fetchStudentsStatus(exam.id)
    setActiveTab(3)
  }

  const handleDeleteExam = async (examId: number, examTitle: string) => {
    if (window.confirm(`Are you sure you want to delete "${examTitle}"?\n\nThis action cannot be undone and will delete all associated questions.`)) {
      try {
        await api.delete(`/exams/${examId}/`)
        alert('‚úÖ Exam deleted successfully!')
        fetchData()
      } catch (error: any) {
        console.error('Error deleting exam:', error)
        alert('‚ùå Error deleting exam: ' + (error.response?.data?.detail || 'Unknown error'))
      }
    }
  }

  const fetchAnnouncements = async () => {
    try {
      const response = await api.get('/announcements/')
      setAnnouncements(response.data)
    } catch (error) {
      console.error('Error fetching announcements:', error)
    }
  }

  const fetchUnreadCount = async () => {
    try {
      const response = await api.get('/announcements/unread_count/')
      setUnreadCount(response.data.unread_count)
    } catch (error) {
      console.error('Error fetching unread count:', error)
    }
  }

  const handleMarkAsRead = async (announcementId: number) => {
    try {
      await api.post(`/announcements/${announcementId}/mark_read/`)
      fetchUnreadCount()
      fetchAnnouncements()
    } catch (error) {
      console.error('Error marking announcement as read:', error)
    }
  }

  const fetchFeedbacks = async () => {
    try {
      const response = await api.get('/feedbacks/')
      setFeedbacks(response.data)
    } catch (error) {
      console.error('Error fetching feedbacks:', error)
    }
  }

  const handleOpenResponseDialog = (feedback: any) => {
    setSelectedFeedback(feedback)
    setTeacherResponse(feedback.teacher_response || '')
    setOpenResponseDialog(true)
  }

  const handleSubmitResponse = async () => {
    if (!teacherResponse.trim()) {
      alert('Please write a response')
      return
    }

    try {
      await api.post(`/feedbacks/${selectedFeedback.id}/add_response/`, {
        teacher_response: teacherResponse
      })
      setOpenResponseDialog(false)
      setTeacherResponse('')
      alert('‚úÖ Response sent successfully!')
      fetchFeedbacks()
    } catch (error: any) {
      console.error('Error submitting response:', error)
      alert('‚ùå Failed to send response: ' + (error.response?.data?.detail || 'Unknown error'))
    }
  }

  const handleMarkFeedbackAsRead = async (feedbackId: number) => {
    if (!window.confirm('Mark this feedback as read without responding?')) {
      return
    }

    try {
      await api.post(`/feedbacks/${feedbackId}/mark_as_read/`)
      alert('‚úÖ Feedback marked as read!')
      fetchFeedbacks()
    } catch (error: any) {
      console.error('Error marking feedback as read:', error)
      alert('‚ùå Failed to mark as read: ' + (error.response?.data?.detail || 'Unknown error'))
    }
  }

  const handleChangePassword = async () => {
    if (!passwordForm.old_password || !passwordForm.new_password || !passwordForm.confirm_password) {
      alert('‚ùå Please fill in all password fields')
      return
    }

    if (passwordForm.new_password !== passwordForm.confirm_password) {
      alert('‚ùå New passwords do not match')
      return
    }

    if (passwordForm.new_password.length < 8) {
      alert('‚ùå New password must be at least 8 characters long')
      return
    }

    try {
      await api.post('/users/change_password/', {
        old_password: passwordForm.old_password,
        new_password: passwordForm.new_password
      })
      setOpenPasswordDialog(false)
      setPasswordForm({ old_password: '', new_password: '', confirm_password: '' })
      alert('‚úÖ Password changed successfully! Please login again with your new password.')
      setTimeout(() => {
        logout()
        navigate('/login')
      }, 2000)
    } catch (error: any) {
      console.error('Error changing password:', error)
      const errorMsg = error.response?.data?.error || error.response?.data?.detail || 'Failed to change password'
      alert(`‚ùå ${errorMsg}`)
    }
  }

  return (
    <Box sx={{ bgcolor: darkMode ? '#121212' : '#f5f5f5', minHeight: '100vh' }}>
      <AppBar position="static" sx={{ bgcolor: darkMode ? '#1e1e1e' : '#1976d2' }}>
        <Toolbar>
          <Typography variant="h6" sx={{ flexGrow: 1 }}>Teacher Dashboard</Typography>
          <IconButton color="inherit" onClick={toggleDarkMode} title={darkMode ? 'Light Mode' : 'Dark Mode'}>
            {darkMode ? <Brightness7 /> : <Brightness4 />}
          </IconButton>
          <Avatar src={user?.profile_picture} sx={{ mx: 2 }} />
          <Typography variant="body1" sx={{ mr: 2 }}>{user?.first_name} {user?.last_name}</Typography>
          <IconButton color="inherit" onClick={(e) => setAnchorEl(e.currentTarget)} title="Settings">
            <Settings />
          </IconButton>
          <Menu
            anchorEl={anchorEl}
            open={Boolean(anchorEl)}
            onClose={() => setAnchorEl(null)}
          >
            <MenuItem onClick={() => { setAnchorEl(null); setOpenPasswordDialog(true); }}>
              <Lock sx={{ mr: 1 }} /> Change Password
            </MenuItem>
            <MenuItem onClick={() => { setAnchorEl(null); logout(); navigate('/login'); }}>
              <Logout sx={{ mr: 1 }} /> Logout
            </MenuItem>
          </Menu>
        </Toolbar>
      </AppBar>

      <Container sx={{ mt: 4, color: darkMode ? '#fff' : 'inherit' }}>
        <Typography variant="h4" gutterBottom>Welcome, {user?.first_name}!</Typography>

        <Grid container spacing={3} sx={{ mb: 4 }}>
          <Grid item xs={12} sm={6} md={3}>
            <Card sx={{ background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)', color: 'white' }}>
              <CardContent>
                <Box sx={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
                  <Box>
                    <Typography variant="body2" sx={{ opacity: 0.9 }}>Total Exams</Typography>
                    <Typography variant="h3" sx={{ fontWeight: 'bold', mt: 1 }}>{stats.totalExams}</Typography>
                  </Box>
                  <School sx={{ fontSize: 60, opacity: 0.3 }} />
                </Box>
              </CardContent>
            </Card>
          </Grid>
          <Grid item xs={12} sm={6} md={3}>
            <Card sx={{ background: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)', color: 'white' }}>
              <CardContent>
                <Box sx={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
                  <Box>
                    <Typography variant="body2" sx={{ opacity: 0.9 }}>Total Students</Typography>
                    <Typography variant="h3" sx={{ fontWeight: 'bold', mt: 1 }}>{stats.totalStudents}</Typography>
                  </Box>
                  <People sx={{ fontSize: 60, opacity: 0.3 }} />
                </Box>
              </CardContent>
            </Card>
          </Grid>
          <Grid item xs={12} sm={6} md={3}>
            <Card sx={{ background: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)', color: 'white' }}>
              <CardContent>
                <Box sx={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
                  <Box>
                    <Typography variant="body2" sx={{ opacity: 0.9 }}>Avg Score</Typography>
                    <Typography variant="h3" sx={{ fontWeight: 'bold', mt: 1 }}>{stats.averageScore.toFixed(1)}%</Typography>
                  </Box>
                  <TrendingUp sx={{ fontSize: 60, opacity: 0.3 }} />
                </Box>
              </CardContent>
            </Card>
          </Grid>
          <Grid item xs={12} sm={6} md={3}>
            <Card sx={{ background: 'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)', color: 'white' }}>
              <CardContent>
                <Box sx={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
                  <Box>
                    <Typography variant="body2" sx={{ opacity: 0.9 }}>Pending Grading</Typography>
                    <Typography variant="h3" sx={{ fontWeight: 'bold', mt: 1 }}>{stats.pendingGrading}</Typography>
                  </Box>
                  <Assessment sx={{ fontSize: 60, opacity: 0.3 }} />
                </Box>
              </CardContent>
            </Card>
          </Grid>
        </Grid>

        <Tabs 
          value={activeTab} 
          onChange={(_, v) => setActiveTab(v)} 
          sx={{ 
            mb: 3, 
            mt: 4, 
            borderBottom: 1, 
            borderColor: 'divider',
            '& .MuiTab-root': { color: darkMode ? '#bbb' : 'inherit' },
            '& .Mui-selected': { color: darkMode ? '#90caf9' : '#1976d2' }
          }}
        >
          <Tab label="My Exams" />
          <Tab label="Analytics" />
          <Tab label="Create Exam" />
          <Tab label="Monitor Students" />
          <Tab 
            label={
              <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
                Announcements
                {unreadCount > 0 && (
                  <Chip 
                    label={unreadCount} 
                    size="small" 
                    color="error" 
                    sx={{ height: 20, minWidth: 20, fontSize: '0.75rem' }}
                  />
                )}
              </Box>
            } 
          />
          <Tab 
            label={
              <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
                Student Feedback
                {feedbacks.filter(f => !f.is_reviewed).length > 0 && (
                  <Chip 
                    label={feedbacks.filter(f => !f.is_reviewed).length} 
                    size="small" 
                    color="warning" 
                    sx={{ height: 20, minWidth: 20, fontSize: '0.75rem' }}
                  />
                )}
              </Box>
            } 
          />
        </Tabs>

        {activeTab === 0 && (
          <Grid container spacing={3}>
            {exams.map((exam) => (
              <Grid item xs={12} md={6} key={exam.id}>
                <Card sx={{ bgcolor: darkMode ? '#1e1e1e' : 'white', color: darkMode ? '#fff' : 'inherit' }}>
                  <CardContent>
                    <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'start' }}>
                      <Typography variant="h6">{exam.title}</Typography>
                      <Chip 
                        label={exam.status} 
                        color={exam.status === 'approved' ? 'success' : exam.status === 'pending' ? 'warning' : 'error'} 
                        size="small"
                      />
                    </Box>
                    <Typography color="textSecondary" gutterBottom>{exam.subject_name}</Typography>
                    <Typography variant="body2">Duration: {exam.duration_minutes} min</Typography>
                    <Typography variant="body2">Questions: {exam.questions_count}</Typography>
                    <Typography variant="body2">Start: {new Date(exam.start_time).toLocaleString()}</Typography>
                    <Box sx={{ mt: 2, display: 'flex', gap: 1, flexWrap: 'wrap' }}>
                      <Button size="small" variant="outlined" onClick={() => { setSelectedExam(exam); setOpenQuestionDialog(true) }}>
                        Add Questions
                      </Button>
                      <Button size="small" variant="outlined" startIcon={<Visibility />} onClick={() => handleMonitorExam(exam)}>
                        Monitor
                      </Button>
                      <Button 
                        size="small" 
                        variant="outlined" 
                        color="error"
                        onClick={() => handleDeleteExam(exam.id, exam.title)}
                      >
                        Delete
                      </Button>
                    </Box>
                  </CardContent>
                </Card>
              </Grid>
            ))}
          </Grid>
        )}

        {activeTab === 1 && (
          <Box>
            <Typography variant="h5" gutterBottom sx={{ mb: 3 }}>Analytics & Insights</Typography>
            <Grid container spacing={3}>
              <Grid item xs={12} md={6}>
                <Paper sx={{ p: 3, bgcolor: darkMode ? '#1e1e1e' : 'white', color: darkMode ? '#fff' : 'inherit' }}>
                  <Typography variant="h6" gutterBottom>
                    Exam Performance Overview
                  </Typography>
              <ResponsiveContainer width="100%" height={300}>
                <BarChart data={chartData.examPerformance}>
                  <CartesianGrid strokeDasharray="3 3" />
                  <XAxis dataKey="name" />
                  <YAxis />
                  <Tooltip />
                  <Legend />
                  <Bar dataKey="average" fill="#8884d8" name="Avg Score %" />
                  <Bar dataKey="students" fill="#82ca9d" name="Students" />
                </BarChart>
              </ResponsiveContainer>
            </Paper>
          </Grid>

          <Grid item xs={12} md={6}>
            <Paper sx={{ p: 3, bgcolor: darkMode ? '#1e1e1e' : 'white', color: darkMode ? '#fff' : 'inherit' }}>
              <Typography variant="h6" gutterBottom>
                Exam Status Distribution
              </Typography>
              <ResponsiveContainer width="100%" height={300}>
                <PieChart>
                  <Pie
                    data={chartData.examStatusDistribution}
                    cx="50%"
                    cy="50%"
                    labelLine={false}
                    label={({ name, percent }) => `${name}: ${(percent * 100).toFixed(0)}%`}
                    outerRadius={80}
                    fill="#8884d8"
                    dataKey="value"
                  >
                    {chartData.examStatusDistribution.map((_: any, index: number) => (
                      <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                    ))}
                  </Pie>
                  <Tooltip />
                </PieChart>
              </ResponsiveContainer>
            </Paper>
          </Grid>

          <Grid item xs={12}>
            <Paper sx={{ p: 3, bgcolor: darkMode ? '#1e1e1e' : 'white', color: darkMode ? '#fff' : 'inherit' }}>
              <Typography variant="h6" gutterBottom>
                Student Progress Tracking
              </Typography>
              <ResponsiveContainer width="100%" height={300}>
                <ComposedChart data={chartData.studentProgress}>
                  <CartesianGrid strokeDasharray="3 3" />
                  <XAxis dataKey="week" />
                  <YAxis />
                  <Tooltip />
                  <Legend />
                  <Area type="monotone" dataKey="completed" fill="#8884d8" stroke="#8884d8" name="Completed" />
                  <Bar dataKey="pending" fill="#ffc658" name="Pending" />
                  <Line type="monotone" dataKey="average" stroke="#ff7300" strokeWidth={2} name="Avg Score" />
                </ComposedChart>
              </ResponsiveContainer>
            </Paper>
          </Grid>

          <Grid item xs={12}>
            <Paper sx={{ p: 3, bgcolor: darkMode ? '#1e1e1e' : 'white', color: darkMode ? '#fff' : 'inherit' }}>
              <Typography variant="h6" gutterBottom>
                Subject-wise Performance
              </Typography>
              <ResponsiveContainer width="100%" height={300}>
                <BarChart data={chartData.subjectWisePerformance} layout="vertical">
                  <CartesianGrid strokeDasharray="3 3" />
                  <XAxis type="number" />
                  <YAxis dataKey="subject" type="category" width={120} />
                  <Tooltip />
                  <Legend />
                  <Bar dataKey="students" fill="#8884d8" name="Students" />
                  <Bar dataKey="avgScore" fill="#82ca9d" name="Avg Score" />
                </BarChart>
              </ResponsiveContainer>
            </Paper>
          </Grid>
        </Grid>
          </Box>
        )}

        {activeTab === 2 && (
          <Paper sx={{ p: 3, bgcolor: darkMode ? '#1e1e1e' : 'white', color: darkMode ? '#fff' : 'inherit' }}>
            <Typography variant="h5" gutterBottom>Create New Exam</Typography>
            
            <Box sx={{ mb: 4, p: 3, border: '2px dashed #1976d2', borderRadius: 2, textAlign: 'center', bgcolor: darkMode ? '#1a2332' : '#f0f7ff', cursor: 'pointer' }}
              onDragOver={(e) => e.preventDefault()}
              onDrop={(e) => {
                e.preventDefault()
                const file = e.dataTransfer.files[0]
                if (file && file.type === 'application/pdf') {
                  handlePdfUpload(file)
                }
              }}>
              <Typography variant="h6" gutterBottom color="primary">
                üìÑ Quick Import from PDF
              </Typography>
              <Typography variant="body2" color="textSecondary" paragraph>
                Drag and drop a PDF file here, or click to browse
              </Typography>
              <Typography variant="caption" color="textSecondary" sx={{ display: 'block', mb: 2 }}>
                Expected format: 1. Question? A) Option A B) Option B C) Option C D) Option D Answer: A
              </Typography>
              <input
                accept="application/pdf"
                style={{ display: 'none' }}
                id="pdf-upload"
                type="file"
                onChange={(e) => {
                  if (e.target.files && e.target.files[0]) {
                    handlePdfUpload(e.target.files[0])
                    e.target.value = ''
                  }
                }}
              />
              <label htmlFor="pdf-upload">
                <Button 
                  variant="contained" 
                  component="span" 
                  size="large"
                  disabled={uploadingPdf}
                >
                  {uploadingPdf ? '‚è≥ Parsing PDF...' : 'üìé Upload PDF'}
                </Button>
              </label>
              {parsedQuestions.length > 0 && (
                <Chip 
                  label={`‚úì ${parsedQuestions.length} questions extracted`} 
                  color="success" 
                  sx={{ mt: 2 }}
                />
              )}
            </Box>

            <Typography variant="h6" gutterBottom sx={{ mt: 4, mb: 2 }}>Exam Details</Typography>
            <Grid container spacing={2}>
              <Grid item xs={12} md={6}>
                <TextField fullWidth label="Title" value={examForm.title} required
                  onChange={(e) => setExamForm({ ...examForm, title: e.target.value })} />
              </Grid>
              <Grid item xs={12} md={6}>
                <TextField fullWidth select label="Subject" value={examForm.subject} required
                  onChange={(e) => setExamForm({ ...examForm, subject: e.target.value })}>
                  {subjects.map((s) => <MenuItem key={s.id} value={s.id}>{s.name}</MenuItem>)}
                </TextField>
              </Grid>
              
              <Grid item xs={12} md={6}>
                <TextField 
                  fullWidth 
                  select 
                  label="Department (Optional)" 
                  value={examForm.department}
                  onChange={(e) => setExamForm({ ...examForm, department: e.target.value, custom_department: '' })}
                  helperText="Select from existing or type custom below"
                >
                  <MenuItem value="">None</MenuItem>
                  {departments.map((d) => <MenuItem key={d.id} value={d.id}>{d.name}</MenuItem>)}
                </TextField>
              </Grid>
              
              <Grid item xs={12} md={6}>
                <TextField 
                  fullWidth 
                  label="Custom Department" 
                  value={examForm.custom_department}
                  onChange={(e) => setExamForm({ ...examForm, custom_department: e.target.value, department: '' })}
                  helperText="Type custom department if not found above"
                  placeholder="e.g., Computer Science, Mathematics"
                />
              </Grid>
              
              <Grid item xs={12} md={6}>
                <TextField 
                  fullWidth 
                  select 
                  label="Course (Optional)" 
                  value={examForm.course}
                  onChange={(e) => setExamForm({ ...examForm, course: e.target.value, custom_course: '' })}
                  helperText="Select from existing or type custom below"
                >
                  <MenuItem value="">None</MenuItem>
                  {courses.map((c) => <MenuItem key={c.id} value={c.id}>{c.name}</MenuItem>)}
                </TextField>
              </Grid>
              
              <Grid item xs={12} md={6}>
                <TextField 
                  fullWidth 
                  label="Custom Course" 
                  value={examForm.custom_course}
                  onChange={(e) => setExamForm({ ...examForm, custom_course: e.target.value, course: '' })}
                  helperText="Type custom course if not found above"
                  placeholder="e.g., Data Structures, Calculus I"
                />
              </Grid>
              
              <Grid item xs={12}>
                <TextField 
                  fullWidth 
                  multiline 
                  rows={2} 
                  label="Additional Information (Optional)" 
                  value={examForm.additional_info}
                  onChange={(e) => setExamForm({ ...examForm, additional_info: e.target.value })}
                  helperText="Any other useful information for the exam (semester, year, section, etc.)"
                  placeholder="e.g., Semester 1, Year 2024, Section A"
                />
              </Grid>
              
              <Grid item xs={12}>
                <TextField fullWidth multiline rows={2} label="Description" value={examForm.description}
                  onChange={(e) => setExamForm({ ...examForm, description: e